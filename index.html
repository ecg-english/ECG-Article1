<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Hub | è‹±èªæ–‡æ³•ãƒ»å®Œå…¨æ”»ç•¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-50 min-h-screen pb-20">
                                        <div>
                    <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <header class="hero-animate bg-slate-900 text-white pt-12 pb-16 px-4 text-center rounded-b-[3rem] shadow-xl mb-10 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
                <i class="fa-solid fa-font hero-bg-icon text-9xl absolute top-[-20px] left-[-20px]"></i>
                <i class="fa-solid fa-quote-right hero-bg-icon text-9xl absolute bottom-[-20px] right-[-20px]"></i>
                        </div>
            <h1 class="hero-title text-3xl md:text-5xl font-bold mb-4 tracking-tight">English Grammar Hub</h1>
            <p class="hero-subtitle text-slate-400 max-w-xl mx-auto">ãƒã‚¤ãƒ†ã‚£ãƒ–ã®è„³å†…ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚<br>æš—è¨˜ã§ã¯ãªãã€Œç†è§£ã€ã§å­¦ã¶ã€æœ€å¼·ã®æ–‡æ³•ã‚¬ã‚¤ãƒ‰ã€‚</p>
                    </header>

                    <!-- ãƒ¬ãƒ™ãƒ«é¸æŠã‚°ãƒªãƒƒãƒ‰ -->
                    <div class="px-4 max-w-4xl mx-auto -mt-10 grid gap-6 md:grid-cols-2 mb-12 relative z-10">
            <!-- è¶…å…¥é–€ã‚«ãƒ¼ãƒ‰ -->
            <a href="level0/" class="level-card card-animate bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-100" data-delay="0" data-level="0">
                <div class="h-2 bg-gradient-to-r from-blue-400 to-blue-600"></div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4 relative">
                        <div class="w-12 h-12 rounded-xl bg-blue-600 text-white flex items-center justify-center text-2xl shadow-md">
                            <i class="fa-solid fa-seedling"></i>
                        </div>
                        <div class="progress-chart" data-level="0">
                            <svg class="progress-ring" width="48" height="48">
                                <defs>
                                    <linearGradient id="gradient-0" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="progress-ring-background" cx="24" cy="24" r="20" fill="none" stroke="#e2e8f0" stroke-width="4"></circle>
                                <circle class="progress-ring-circle" cx="24" cy="24" r="20" fill="none" stroke="url(#gradient-0)" stroke-width="4" stroke-linecap="round" transform="rotate(-90 24 24)"></circle>
                            </svg>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">è¶…å…¥é–€</h2>
                    <p class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-3">Level 0: The Core</p>
                    <p class="text-sm text-slate-500 mb-6 min-h-[3em]">è‹±èªã®ã€Œéª¨æ ¼ã€ã‚’ä½œã‚‹ã€‚ã¾ãšã¯ã“ã“ã‹ã‚‰ã€‚</p>
                    <div class="flex items-center text-sm font-bold text-blue-600 group">
                        å­¦ç¿’ã‚’å§‹ã‚ã‚‹ <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                    </div>
                </div>
            </a>

            <!-- åˆç´šã‚«ãƒ¼ãƒ‰ -->
            <a href="level1/" class="level-card card-animate bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-100" data-delay="100" data-level="1">
                <div class="h-2 bg-gradient-to-r from-green-400 to-green-600"></div>
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4 relative">
                        <div class="w-12 h-12 rounded-xl bg-emerald-600 text-white flex items-center justify-center text-2xl shadow-md">
                            <i class="fa-solid fa-earth-americas"></i>
                            </div>
                        <div class="progress-chart" data-level="1">
                            <svg class="progress-ring" width="48" height="48">
                                <defs>
                                    <linearGradient id="gradient-1" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#34d399;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="progress-ring-background" cx="24" cy="24" r="20" fill="none" stroke="#e2e8f0" stroke-width="4"></circle>
                                <circle class="progress-ring-circle" cx="24" cy="24" r="20" fill="none" stroke="url(#gradient-1)" stroke-width="4" stroke-linecap="round" transform="rotate(-90 24 24)"></circle>
                            </svg>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">åˆç´š</h2>
                    <p class="text-xs font-bold text-green-600 uppercase tracking-wider mb-3">Level 1: Expanding the World</p>
                    <p class="text-sm text-slate-500 mb-6 min-h-[3em]">ã€Œæ™‚ã€ã¨ã€Œæƒ…å ±ã€ã‚’æ“ã‚‹ã€‚éå»ãƒ»æœªæ¥ãƒ»é€²è¡Œå½¢ãƒ»ç–‘å•è©ã€‚</p>
                    <div class="flex items-center text-sm font-bold text-green-600 group">
                        å­¦ç¿’ã‚’å§‹ã‚ã‚‹ <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                    </div>
                </div>
            </a>

            <!-- ä¸­ç´šã‚«ãƒ¼ãƒ‰ -->
            <a href="level2/" class="level-card card-animate bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-100" data-delay="200" data-level="2">
                <div class="h-2 bg-gradient-to-r from-orange-400 to-orange-600"></div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4 relative">
                        <div class="w-12 h-12 rounded-xl bg-orange-500 text-white flex items-center justify-center text-2xl shadow-md">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <div class="progress-chart" data-level="2">
                            <svg class="progress-ring" width="48" height="48">
                                <defs>
                                    <linearGradient id="gradient-2" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#fb923c;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#f97316;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="progress-ring-background" cx="24" cy="24" r="20" fill="none" stroke="#e2e8f0" stroke-width="4"></circle>
                                <circle class="progress-ring-circle" cx="24" cy="24" r="20" fill="none" stroke="url(#gradient-2)" stroke-width="4" stroke-linecap="round" transform="rotate(-90 24 24)"></circle>
                            </svg>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">ä¸­ç´š</h2>
                    <p class="text-xs font-bold text-orange-600 uppercase tracking-wider mb-3">Level 2: Nuance</p>
                    <p class="text-sm text-slate-500 mb-6 min-h-[3em]">åŠ©å‹•è©ã®æ‹¡å¼µã€å®Œäº†å½¢ã€æ¯”è¼ƒãªã©ã€‚</p>
                    <div class="flex items-center text-sm font-bold text-orange-600 group">
                            å­¦ç¿’ã‚’å§‹ã‚ã‚‹ <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                    </div>
                </div>
            </a>

            <!-- ä¸Šç´šã‚«ãƒ¼ãƒ‰ -->
            <a href="level3/" class="level-card card-animate bg-white rounded-2xl shadow-lg overflow-hidden border border-slate-100" data-delay="300" data-level="3">
                <div class="h-2 bg-gradient-to-r from-red-400 to-red-600"></div>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4 relative">
                        <div class="w-12 h-12 rounded-xl bg-rose-600 text-white flex items-center justify-center text-2xl shadow-md">
                            <i class="fa-solid fa-chess"></i>
                        </div>
                        <div class="progress-chart" data-level="3">
                            <svg class="progress-ring" width="48" height="48">
                                <defs>
                                    <linearGradient id="gradient-3" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f43f5e;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#e11d48;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle class="progress-ring-background" cx="24" cy="24" r="20" fill="none" stroke="#e2e8f0" stroke-width="4"></circle>
                                <circle class="progress-ring-circle" cx="24" cy="24" r="20" fill="none" stroke="url(#gradient-3)" stroke-width="4" stroke-linecap="round" transform="rotate(-90 24 24)"></circle>
                            </svg>
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 mb-1">ä¸Šç´š</h2>
                    <p class="text-xs font-bold text-red-600 uppercase tracking-wider mb-3">Level 3: Logic</p>
                    <p class="text-sm text-slate-500 mb-6 min-h-[3em]">é–¢ä¿‚ä»£åè©ã€ä»®å®šæ³•ã€é«˜åº¦ãªæ§‹æ–‡ã€‚</p>
                    <div class="flex items-center text-sm font-bold text-red-600 group">
                        å­¦ç¿’ã‚’å§‹ã‚ã‚‹ <i class="fa-solid fa-arrow-right ml-2 transition-transform group-hover:translate-x-1"></i>
                    </div>
                </div>
            </a>
        </div>
        
        <footer class="footer-animate text-center text-slate-400 text-sm pb-10">
            &copy; 2025 è‹±ä¼šè©±ã‚¸ãƒ  ECG
        </footer>
    </div>

    <!-- ECGãã‚“ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <button id="ecgKunButton" class="ecg-kun-button fixed bottom-6 right-6 z-50 w-16 h-16 rounded-full bg-white shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center border-2 border-blue-200 hover:border-blue-400">
        <img id="ecgKunFloatingImg" src="image/ECGkun.png" alt="ECGãã‚“" class="w-12 h-12 object-contain">
    </button>

    <!-- ECGãã‚“ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ecgChatModal" class="ecg-chat-modal fixed inset-0 z-[100] flex items-center justify-center pointer-events-none">
        <div class="ecg-chat-overlay absolute inset-0 bg-black/30 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
        <div class="ecg-chat-container relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl h-[80vh] max-h-[800px] flex flex-col transform scale-95 opacity-0 transition-all duration-300">
            <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="ecg-chat-header bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-t-2xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img id="ecgKunHeaderImg" src="image/ECGkun.png" alt="ECGãã‚“" class="w-10 h-10 object-contain">
                    <div>
                        <h3 class="font-bold text-lg">ECGãã‚“</h3>
                        <p class="text-xs text-blue-100">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="ecgChatSettings" class="text-white/80 hover:text-white transition-colors" title="ECGãã‚“ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º">
                        <i class="fa-solid fa-palette text-lg"></i>
                    </button>
                    <button id="ecgChatClose" class="text-white/80 hover:text-white transition-colors">
                        <i class="fa-solid fa-times text-xl"></i>
                        </button>
                </div>
                    </div>

            <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
            <div id="ecgChatMessages" class="ecg-chat-messages flex-1 overflow-y-auto p-4 space-y-4">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                    </div>

            <!-- ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆé¸æŠè‚¢ãƒœã‚¿ãƒ³ç”¨ï¼‰ -->
            <div id="ecgChatOptions" class="ecg-chat-options p-4 border-t border-slate-200 space-y-2">
                <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
            </div>
        </div>
    </div>

    <!-- ECGãã‚“ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ecgCustomizeModal" class="ecg-customize-modal fixed inset-0 z-[110] flex items-center justify-center pointer-events-none">
        <div class="ecg-customize-overlay absolute inset-0 bg-black/40 backdrop-blur-sm opacity-0 transition-opacity duration-300"></div>
        <div class="ecg-customize-container relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col transform scale-95 opacity-0 transition-all duration-300">
            <div class="ecg-customize-header bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-t-2xl flex items-center justify-between">
                <h3 class="font-bold text-lg">ECGãã‚“ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
                <button id="ecgCustomizeClose" class="text-white/80 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            <div class="ecg-customize-content p-6 overflow-y-auto">
                <p class="text-sm text-slate-600 mb-4">ãƒ¬ãƒƒã‚¹ãƒ³ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ã€æ–°ã—ã„ECGãã‚“ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒè§£æ”¾ã•ã‚Œã¾ã™ï¼</p>
                <div id="ecgCustomizeGrid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- ç”»åƒé¸æŠã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å„ãƒ¬ãƒ™ãƒ«ã®ãƒ¬ãƒƒã‚¹ãƒ³æ•°ã¨ãƒ¬ãƒƒã‚¹ãƒ³IDã®å®šç¾©
        const levelConfig = {
            0: { total: 8, lessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8'] },
            1: { total: 7, lessons: ['l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15'] },
            2: { total: 8, lessons: ['l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23'] },
            3: { total: 7, lessons: ['l3-24', 'l3-25', 'l3-26', 'l3-27', 'l3-28', 'l3-29', 'l3-30'] }
        };

        // é”æˆç‡ã‚’è¨ˆç®—ã—ã¦å††ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        function updateProgressChart(level, delay = 0) {
            const config = levelConfig[level];
            if (!config) return;

            let completedCount = 0;
            config.lessons.forEach(lessonId => {
                const key = `lesson_completed_${lessonId}`;
                if (localStorage.getItem(key) === 'true') {
                    completedCount++;
                }
            });

            const percentage = Math.round((completedCount / config.total) * 100);
            const chart = document.querySelector(`.progress-chart[data-level="${level}"]`);
            if (!chart) return;

            const circle = chart.querySelector('.progress-ring-circle');
            const text = chart.querySelector('.progress-text');
            
            if (circle && text) {
                const circumference = 2 * Math.PI * 20; // r=20
                const offset = circumference - (percentage / 100) * circumference;
                
                // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                circle.style.strokeDashoffset = circumference; // 0%ã‹ã‚‰é–‹å§‹
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ã‚’é…å»¶
                setTimeout(() => {
                    circle.style.strokeDashoffset = offset;
                    
                    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    animateCounter(text, 0, percentage, 800);
                }, delay);
            }
        }

        // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function animateCounter(element, start, end, duration) {
            const startTime = performance.now();
            const animate = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°é–¢æ•°ï¼ˆease-outï¼‰
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (end - start) * easeOut);
                
                element.textContent = `${current}%`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    element.textContent = `${end}%`;
                }
            };
            requestAnimationFrame(animate);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™ºå‹•
        document.addEventListener('DOMContentLoaded', function() {
            // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé †ç•ªã«è¡¨ç¤ºã€ã‚ˆã‚Šé•·ã„é–“éš”ã§ï¼‰
            const cards = document.querySelectorAll('.card-animate');
            cards.forEach((card, index) => {
                const delay = parseInt(card.getAttribute('data-delay')) || 0;
                const level = parseInt(card.getAttribute('data-level')) || 0;
                const cardDelay = 300 + delay * 0.5;
                
                setTimeout(() => {
                    card.classList.add('visible');
                    
                    // ã‚«ãƒ¼ãƒ‰å†…ã®è¦ç´ ã«ã‚‚å€‹åˆ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    const icon = card.querySelector('.w-12');
                    const title = card.querySelector('h2');
                    const desc = card.querySelector('p.text-xs');
                    const text = card.querySelector('p.text-sm');
                    const button = card.querySelector('.flex.items-center');
                    
                    if (icon) {
                        setTimeout(() => {
                            icon.style.animationDelay = '0.1s';
                        }, 100);
                    }
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã®é †æ¬¡è¡¨ç¤º
                    [title, desc, text, button].forEach((el, i) => {
                        if (el) {
                            el.style.opacity = '0';
                            el.style.transform = 'translateY(10px)';
                            setTimeout(() => {
                                el.style.transition = 'all 0.3s ease-out';
                                el.style.opacity = '1';
                                el.style.transform = 'translateY(0)';
                            }, 50 + (i * 50));
                        }
                    });
                    
                    // å††ã‚°ãƒ©ãƒ•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºå¾Œã«é–‹å§‹
                    // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + å††ã‚°ãƒ©ãƒ•ã®åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + æç”»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é…å»¶
                    updateProgressChart(level, cardDelay + 600);
                }, cardDelay);
            });

            // ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const footer = document.querySelector('.footer-animate');
            setTimeout(() => {
                footer.classList.add('visible');
            }, 600); // ã‚«ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è¡¨ç¤º

            // ECGãã‚“ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã®åˆæœŸåŒ–
            initECGChat();
        });

        // ECGãã‚“ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
        function initECGChat() {
            const chatButton = document.getElementById('ecgKunButton');
            const chatModal = document.getElementById('ecgChatModal');
            const chatClose = document.getElementById('ecgChatClose');
            const chatMessages = document.getElementById('ecgChatMessages');
            const chatOptions = document.getElementById('ecgChatOptions');

            // Q&Aãƒ‡ãƒ¼ã‚¿ã¨æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            const qaData = [
                {
                    question: 'ä»Šã®å­¦ç¿’é€²æ—ã‚’æ•™ãˆã¦',
                    type: 'progress',
                    answer: null // å‹•çš„ã«ç”Ÿæˆ
                },
                {
                    question: 'ãŠã™ã™ã‚ã®ãƒ¬ãƒƒã‚¹ãƒ³ã¯ï¼Ÿ',
                    type: 'recommendation',
                    answer: null // å‹•çš„ã«ç”Ÿæˆ
                },
                {
                    question: 'ç¢ºèªå•é¡ŒãŒè§£ã‘ãªã„æ™‚ã¯ï¼Ÿ',
                    answer: 'ç¢ºèªå•é¡Œã§é–“é•ãˆãŸæ™‚ã¯ã€ãã®ãƒ¬ãƒƒã‚¹ãƒ³ã®å†…å®¹ã‚’ã‚‚ã†ä¸€åº¦èª­ã¿è¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ç‰¹ã«ã€Œã‚ˆãã‚ã‚‹é–“é•ã„ã€ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã¨ã€è‡ªåˆ†ã®ãƒŸã‚¹ã«æ°—ã¥ã‘ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚ä½•åº¦ã‚‚æŒ‘æˆ¦ã§ãã‚‹ã®ã§ã€ç„¦ã‚‰ãšã«ç†è§£ã‚’æ·±ã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼'
                },
                {
                    question: 'ã©ã®é †ç•ªã§å­¦ç¿’ã™ã‚Œã°ã„ã„ï¼Ÿ',
                    answer: 'åŸºæœ¬çš„ã«ã¯å„ãƒ¬ãƒ™ãƒ«å†…ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’é †ç•ªã«é€²ã‚ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚ç‰¹ã«ã€Œè¶…å…¥é–€ã€ã¯è‹±èªã®åŸºç¤ã¨ãªã‚‹é‡è¦ãªå†…å®¹ãªã®ã§ã€ã—ã£ã‹ã‚Šã¨ç†è§£ã—ã¦ã‹ã‚‰æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚ãŸã ã—ã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§ç„¡ç†ãªãé€²ã‚ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚'
                },
                {
                    question: 'ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚‰ãªã„æ™‚ã¯ï¼Ÿ',
                    answer: 'ãã‚“ãªæ™‚ã“ãã€å°ã•ãªç›®æ¨™ã‚’ç«‹ã¦ã¦ã¿ã¾ã—ã‚‡ã†ï¼ã€Œä»Šæ—¥ã¯1ãƒ¬ãƒƒã‚¹ãƒ³ã ã‘ã‚¯ãƒªã‚¢ã™ã‚‹ã€ãªã©ã€é”æˆã—ã‚„ã™ã„ç›®æ¨™ã‚’è¨­å®šã™ã‚‹ã¨ã€é”æˆæ„ŸãŒå¾—ã‚‰ã‚Œã¦ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸ŠãŒã‚Šã¾ã™ã€‚ã¾ãŸã€ãƒ›ãƒ¼ãƒ ç”»é¢ã®é”æˆåº¦ã‚°ãƒ©ãƒ•ã‚’è¦‹ã‚‹ã¨ã€è‡ªåˆ†ã®æˆé•·ãŒå®Ÿæ„Ÿã§ãã¦ã‚„ã‚‹æ°—ãŒå‡ºã¾ã™ã‚ˆï¼'
                },
                {
                    question: 'è‹±èªãŒè‹¦æ‰‹ã ã‘ã©å¤§ä¸ˆå¤«ï¼Ÿ',
                    answer: 'å¤§ä¸ˆå¤«ã§ã™ï¼ã“ã®ã‚µã‚¤ãƒˆã¯ã€Œæš—è¨˜ã€ã§ã¯ãªãã€Œç†è§£ã€ã§å­¦ã¹ã‚‹ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚é›£ã—ã„ç”¨èªã‚’ä½¿ã‚ãšã€ã‚ã‹ã‚Šã‚„ã™ã„ä¾‹æ–‡ã¨å›³è§£ã§èª¬æ˜ã—ã¦ã„ã‚‹ã®ã§ã€è‹±èªãŒè‹¦æ‰‹ãªæ–¹ã§ã‚‚ç„¡ç†ãªãå­¦ç¿’ã§ãã¾ã™ã€‚ç„¦ã‚‰ãšã€è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã¦ã„ãã¾ã—ã‚‡ã†ï¼'
                }
            ];

            let isInitialized = false;

            // ãƒãƒ£ãƒƒãƒˆã‚’é–‹ã
            function openChat() {
                chatModal.classList.add('active');
                if (!isInitialized) {
                    showInitialMessage();
                    isInitialized = true;
                }
            }

            // ãƒãƒ£ãƒƒãƒˆã‚’é–‰ã˜ã‚‹
            function closeChat() {
                chatModal.classList.remove('active');
            }

            // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            function showInitialMessage() {
                chatMessages.innerHTML = '';
                chatOptions.innerHTML = '';

                const selectedImageId = localStorage.getItem('ecg_selected_image') || 'default';
                const ecgImages = [
                    { id: 'default', path: 'image/ECGkun.png' },
                    { id: 'lv1', path: 'image/ECGkun-lv1.png' },
                    { id: 'lv2', path: 'image/ECGkun-lv2.png' },
                    { id: 'lv3', path: 'image/ECGkun-lv3.png' },
                    { id: 'lv4', path: 'image/ECGkun-lv4.png' },
                    { id: 'lv5', path: 'image/ECGkun-lv5.png' },
                    { id: 'lv6', path: 'image/ECGkun-lv6.png' },
                    { id: 'lv7', path: 'image/ECGkun-lv7.png' },
                    { id: 'lv8', path: 'image/ECGkun-lv8.png' },
                    { id: 'lv9', path: 'image/ECGkun-lv9.png' },
                    { id: 'lv10', path: 'image/ECGkun-lv10.png' }
                ];
                const selectedImage = ecgImages.find(img => img.id === selectedImageId) || ecgImages[0];
                
                const initialMessage = `
                    <div class="ecg-message ecg-message-ecg">
                        <div class="ecg-message-avatar">
                            <img src="${selectedImage.path}" alt="ECGãã‚“">
                        </div>
                        <div class="ecg-message-content">
                            <p>ã“ã‚“ã«ã¡ã¯ï¼ECGãã‚“ã§ã™ï¼ğŸ‘‹</p>
                            <p class="mt-2">ã“ã®Grammar Hubã‚µã‚¤ãƒˆã¸ã‚ˆã†ã“ãï¼</p>
                            <p class="mt-2">ã“ã®ã‚µã‚¤ãƒˆã¯ã€è‹±èªã®æ–‡æ³•ã‚’ã€Œæš—è¨˜ã€ã§ã¯ãªãã€Œç†è§£ã€ã§å­¦ã¹ã‚‹ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</p>
                            <p class="mt-2"><strong>ä½¿ã„æ–¹ï¼š</strong></p>
                            <ul class="mt-2 space-y-1 text-sm list-disc list-inside">
                                <li>4ã¤ã®ãƒ¬ãƒ™ãƒ«ï¼ˆè¶…å…¥é–€ãƒ»åˆç´šãƒ»ä¸­ç´šãƒ»ä¸Šç´šï¼‰ã‹ã‚‰é¸ã‚“ã§å­¦ç¿’ã‚’å§‹ã‚ã¾ã™</li>
                                <li>å„ãƒ¬ãƒƒã‚¹ãƒ³ã‚’èª­ã‚“ã å¾Œã€ã€Œã“ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å®Œäº†ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã§ç¢ºèªå•é¡Œã«æŒ‘æˆ¦</li>
                                <li>5å•ã™ã¹ã¦æ­£è§£ã™ã‚‹ã¨ã€ãã®ãƒ¬ãƒƒã‚¹ãƒ³ãŒã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã™</li>
                                <li>ãƒ›ãƒ¼ãƒ ç”»é¢ã®å††ã‚°ãƒ©ãƒ•ã§é”æˆåº¦ã‚’ç¢ºèªã§ãã¾ã™</li>
                            </ul>
                            <p class="mt-3">ä½•ã‹è³ªå•ãŒã‚ã‚Œã°ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã­ï¼</p>
                        </div>
                    </div>
                `;
                chatMessages.innerHTML = initialMessage;
                scrollToBottom();

                // Q&Aé¸æŠè‚¢ã‚’è¡¨ç¤º
                setTimeout(() => {
                    showQAOptions();
                }, 500);
            }

            // Q&Aé¸æŠè‚¢ã‚’è¡¨ç¤º
            function showQAOptions() {
                chatOptions.innerHTML = '';
                qaData.forEach((qa, index) => {
                    const button = document.createElement('button');
                    button.className = 'ecg-option-button';
                    button.textContent = qa.question;
                    button.addEventListener('click', () => {
                        showAnswer(qa.question, qa.answer, qa.type);
                        chatOptions.innerHTML = '';
                    });
                    chatOptions.appendChild(button);
                });
            }

            // å­¦ç¿’é€²æ—ã‚’å–å¾—
            function getProgress() {
                const levelConfig = {
                    0: { total: 8, lessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8'], name: 'è¶…å…¥é–€' },
                    1: { total: 7, lessons: ['l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15'], name: 'åˆç´š' },
                    2: { total: 8, lessons: ['l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23'], name: 'ä¸­ç´š' },
                    3: { total: 7, lessons: ['l3-24', 'l3-25', 'l3-26', 'l3-27', 'l3-28', 'l3-29', 'l3-30'], name: 'ä¸Šç´š' }
                };

                let totalLessons = 0;
                let completedLessons = 0;
                const levelProgress = [];

                Object.keys(levelConfig).forEach(level => {
                    const config = levelConfig[level];
                    let levelCompleted = 0;
                    config.lessons.forEach(lessonId => {
                        totalLessons++;
                        const key = `lesson_completed_${lessonId}`;
                        if (localStorage.getItem(key) === 'true') {
                            completedLessons++;
                            levelCompleted++;
                        }
                    });
                    const percentage = Math.round((levelCompleted / config.total) * 100);
                    levelProgress.push({
                        name: config.name,
                        completed: levelCompleted,
                        total: config.total,
                        percentage: percentage
                    });
                });

                return {
                    total: completedLessons,
                    totalLessons: totalLessons,
                    percentage: Math.round((completedLessons / totalLessons) * 100),
                    levels: levelProgress
                };
            }

            // ãŠã™ã™ã‚ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å–å¾—
            function getRecommendation() {
                const levelConfig = {
                    0: { lessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8'], name: 'è¶…å…¥é–€', url: 'level0/' },
                    1: { lessons: ['l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15'], name: 'åˆç´š', url: 'level1/' },
                    2: { lessons: ['l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23'], name: 'ä¸­ç´š', url: 'level2/' },
                    3: { lessons: ['l3-24', 'l3-25', 'l3-26', 'l3-27', 'l3-28', 'l3-29', 'l3-30'], name: 'ä¸Šç´š', url: 'level3/' }
                };

                // æœªå®Œäº†ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’æ¢ã™
                for (let level = 0; level <= 3; level++) {
                    const config = levelConfig[level];
                    for (let i = 0; i < config.lessons.length; i++) {
                        const lessonId = config.lessons[i];
                        const key = `lesson_completed_${lessonId}`;
                        if (localStorage.getItem(key) !== 'true') {
                            const lessonNum = level === 0 ? i + 1 : (level === 1 ? i + 9 : (level === 2 ? i + 16 : i + 24));
                            return {
                                level: config.name,
                                lessonNum: lessonNum,
                                url: `${config.url}lesson-${lessonId}.html`
                            };
                        }
                    }
                }

                return null; // ã™ã¹ã¦å®Œäº†
            }

            // å›ç­”ã‚’è¡¨ç¤º
            function showAnswer(question, answer, type) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’è¡¨ç¤º
                const userMessage = document.createElement('div');
                userMessage.className = 'ecg-message ecg-message-user';
                userMessage.innerHTML = `
                    <div class="ecg-message-avatar">
                        <i class="fa-solid fa-user text-blue-500 text-xl flex items-center justify-center h-full"></i>
                    </div>
                    <div class="ecg-message-content">
                        <p>${question}</p>
                    </div>
                `;
                chatMessages.appendChild(userMessage);
                scrollToBottom();

                // ECGãã‚“ã®å›ç­”ã‚’è¡¨ç¤º
                setTimeout(() => {
                    const ecgMessage = document.createElement('div');
                    ecgMessage.className = 'ecg-message ecg-message-ecg';
                    
                    let answerText = '';
                    
                    if (type === 'progress') {
                        const progress = getProgress();
                        answerText = `
                            <p><strong>ç¾åœ¨ã®å­¦ç¿’é€²æ—ï¼š</strong></p>
                            <p class="mt-2">å…¨ä½“ã§ <strong>${progress.total}/${progress.totalLessons}ãƒ¬ãƒƒã‚¹ãƒ³</strong> ã‚¯ãƒªã‚¢ï¼ˆ${progress.percentage}%ï¼‰</p>
                            <div class="mt-3 space-y-2">
                                ${progress.levels.map(level => `
                                    <p class="text-sm">${level.name}: ${level.completed}/${level.total}ãƒ¬ãƒƒã‚¹ãƒ³ï¼ˆ${level.percentage}%ï¼‰</p>
                                `).join('')}
                        </div>
                            <p class="mt-3">ç´ æ™´ã‚‰ã—ã„é€²æ—ã§ã™ã­ï¼ã“ã®èª¿å­ã§é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ğŸ’ª</p>
                        `;
                    } else if (type === 'recommendation') {
                        const recommendation = getRecommendation();
                        if (recommendation) {
                            answerText = `
                                <p>æ¬¡ã¯ <strong>${recommendation.level}</strong> ã® <strong>ãƒ¬ãƒƒã‚¹ãƒ³${recommendation.lessonNum}</strong> ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                                <p class="mt-2">é †ç•ªã«å­¦ç¿’ã‚’é€²ã‚ã‚‹ã¨ã€ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã‚ˆã€‚é ‘å¼µã£ã¦ãã ã•ã„ï¼âœ¨</p>
                            `;
                        } else {
                            answerText = `
                                <p>ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼ã™ã¹ã¦ã®ãƒ¬ãƒƒã‚¹ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼</p>
                                <p class="mt-2">å¾©ç¿’ã¨ã—ã¦ã€ã‚‚ã†ä¸€åº¦ç¢ºèªå•é¡Œã«æŒ‘æˆ¦ã—ã¦ã¿ã‚‹ã®ã‚‚ãŠã™ã™ã‚ã§ã™ã€‚ç†è§£ã‚’ã•ã‚‰ã«æ·±ã‚ã‚‰ã‚Œã¾ã™ã‚ˆï¼</p>
                            `;
                        }
                    } else {
                        answerText = `<p>${answer}</p>`;
                    }
                    
                    const selectedImageId = localStorage.getItem('ecg_selected_image') || 'default';
                    const ecgImages = [
                        { id: 'default', path: 'image/ECGkun.png' },
                        { id: 'lv1', path: 'image/ECGkun-lv1.png' },
                        { id: 'lv2', path: 'image/ECGkun-lv2.png' },
                        { id: 'lv3', path: 'image/ECGkun-lv3.png' },
                        { id: 'lv4', path: 'image/ECGkun-lv4.png' },
                        { id: 'lv5', path: 'image/ECGkun-lv5.png' },
                        { id: 'lv6', path: 'image/ECGkun-lv6.png' },
                        { id: 'lv7', path: 'image/ECGkun-lv7.png' },
                        { id: 'lv8', path: 'image/ECGkun-lv8.png' },
                        { id: 'lv9', path: 'image/ECGkun-lv9.png' },
                        { id: 'lv10', path: 'image/ECGkun-lv10.png' }
                    ];
                    const selectedImage = ecgImages.find(img => img.id === selectedImageId) || ecgImages[0];
                    
                    ecgMessage.innerHTML = `
                        <div class="ecg-message-avatar">
                            <img src="${selectedImage.path}" alt="ECGãã‚“">
                        </div>
                        <div class="ecg-message-content">
                            ${answerText}
                </div>
            `;
                    chatMessages.appendChild(ecgMessage);
                    scrollToBottom();

                    // å†åº¦Q&Aé¸æŠè‚¢ã‚’è¡¨ç¤º
                    setTimeout(() => {
                        showQAOptions();
                    }, 500);
                }, 300);
            }

            // ãƒãƒ£ãƒƒãƒˆã‚’æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            function scrollToBottom() {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            chatButton.addEventListener('click', openChat);
            chatClose.addEventListener('click', closeChat);
            chatModal.querySelector('.ecg-chat-overlay').addEventListener('click', closeChat);

            // ECGãã‚“ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½ã®åˆæœŸåŒ–
            initECGCustomize();
        }

        // ECGãã‚“ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ©Ÿèƒ½
        function initECGCustomize() {
            const customizeButton = document.getElementById('ecgChatSettings');
            const customizeModal = document.getElementById('ecgCustomizeModal');
            const customizeClose = document.getElementById('ecgCustomizeClose');
            const customizeGrid = document.getElementById('ecgCustomizeGrid');
            const floatingImg = document.getElementById('ecgKunFloatingImg');
            const headerImg = document.getElementById('ecgKunHeaderImg');

            // ç”»åƒè¨­å®šãƒ‡ãƒ¼ã‚¿
            // requiredLessons: è§£æ”¾ã«å¿…è¦ãªãƒ¬ãƒƒã‚¹ãƒ³IDã®é…åˆ—ï¼ˆã™ã¹ã¦ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
            const ecgImages = [
                { id: 'default', name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', path: 'image/ECGkun.png', requiredLessons: [] },
                { id: 'lv1', name: 'ãƒ¬ãƒ™ãƒ«1', path: 'image/ECGkun-lv1.png', requiredLessons: ['l0-1', 'l0-2'] },
                { id: 'lv2', name: 'ãƒ¬ãƒ™ãƒ«2', path: 'image/ECGkun-lv2.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5'] },
                { id: 'lv3', name: 'ãƒ¬ãƒ™ãƒ«3', path: 'image/ECGkun-lv3.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6'] },
                { id: 'lv4', name: 'ãƒ¬ãƒ™ãƒ«4', path: 'image/ECGkun-lv4.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12'] },
                { id: 'lv5', name: 'ãƒ¬ãƒ™ãƒ«5', path: 'image/ECGkun-lv5.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15'] },
                { id: 'lv6', name: 'ãƒ¬ãƒ™ãƒ«6', path: 'image/ECGkun-lv6.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15', 'l2-16', 'l2-17', 'l2-18', 'l2-19'] },
                { id: 'lv7', name: 'ãƒ¬ãƒ™ãƒ«7', path: 'image/ECGkun-lv7.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15', 'l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23'] },
                { id: 'lv8', name: 'ãƒ¬ãƒ™ãƒ«8', path: 'image/ECGkun-lv8.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15', 'l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23', 'l3-24', 'l3-25', 'l3-26'] },
                { id: 'lv9', name: 'ãƒ¬ãƒ™ãƒ«9', path: 'image/ECGkun-lv9.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15', 'l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23', 'l3-24', 'l3-25', 'l3-26', 'l3-27', 'l3-28'] },
                { id: 'lv10', name: 'ãƒ¬ãƒ™ãƒ«10', path: 'image/ECGkun-lv10.png', requiredLessons: ['l0-1', 'l0-2', 'l0-3', 'l0-4', 'l0-5', 'l0-6', 'l0-7', 'l0-8', 'l1-9', 'l1-10', 'l1-11', 'l1-12', 'l1-13', 'l1-14', 'l1-15', 'l2-16', 'l2-17', 'l2-18', 'l2-19', 'l2-20', 'l2-21', 'l2-22', 'l2-23', 'l3-24', 'l3-25', 'l3-26', 'l3-27', 'l3-28', 'l3-29', 'l3-30'] }
            ];

            // æŒ‡å®šã•ã‚ŒãŸãƒ¬ãƒƒã‚¹ãƒ³ãŒã™ã¹ã¦å®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            function areLessonsCompleted(lessonIds) {
                if (!lessonIds || lessonIds.length === 0) return true;
                
                return lessonIds.every(lessonId => {
                    const key = `lesson_completed_${lessonId}`;
                    return localStorage.getItem(key) === 'true';
                });
            }

            // ãƒ¬ãƒƒã‚¹ãƒ³IDã‹ã‚‰ãƒ¬ãƒƒã‚¹ãƒ³ç•ªå·ã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
            function getLessonNumber(lessonId) {
                const match = lessonId.match(/l(\d+)-(\d+)/);
                if (match) {
                    const level = parseInt(match[1]);
                    const num = parseInt(match[2]);
                    return num;
                }
                return null;
            }

            // ãƒ¬ãƒƒã‚¹ãƒ³ç¯„å›²ã®è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            function getRequiredLessonsText(lessonIds) {
                if (!lessonIds || lessonIds.length === 0) return '';
                
                if (lessonIds.length === 1) {
                    const num = getLessonNumber(lessonIds[0]);
                    return num ? `ãƒ¬ãƒƒã‚¹ãƒ³${num}` : '';
                }
                
                const firstNum = getLessonNumber(lessonIds[0]);
                const lastNum = getLessonNumber(lessonIds[lessonIds.length - 1]);
                
                if (firstNum && lastNum) {
                    return `ãƒ¬ãƒƒã‚¹ãƒ³${firstNum}~${lastNum}`;
                }
                return '';
            }

            // é¸æŠä¸­ã®ç”»åƒã‚’å–å¾—
            function getSelectedImage() {
                return localStorage.getItem('ecg_selected_image') || 'default';
            }

            // ç”»åƒã‚’é©ç”¨
            function applyImage(imageId) {
                const image = ecgImages.find(img => img.id === imageId) || ecgImages[0];
                floatingImg.src = image.path;
                headerImg.src = image.path;
                
                // ãƒãƒ£ãƒƒãƒˆå†…ã®ECGãã‚“ç”»åƒã‚‚æ›´æ–°
                const chatAvatars = document.querySelectorAll('.ecg-message-ecg .ecg-message-avatar img');
                chatAvatars.forEach(avatar => {
                    avatar.src = image.path;
                });
            }

            // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            function openCustomizeModal() {
                customizeModal.classList.add('active');
                renderCustomizeGrid();
            }

            // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            function closeCustomizeModal() {
                customizeModal.classList.remove('active');
            }

            // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚°ãƒªãƒƒãƒ‰ã‚’æç”»
            function renderCustomizeGrid() {
                customizeGrid.innerHTML = '';
                const selectedId = getSelectedImage();

                ecgImages.forEach(image => {
                    const isUnlocked = areLessonsCompleted(image.requiredLessons);
                    const isSelected = image.id === selectedId;
                    const requiredText = getRequiredLessonsText(image.requiredLessons);

                    const card = document.createElement('div');
                    card.className = `ecg-image-card relative bg-white rounded-xl border-2 overflow-hidden transition-all ${
                        isUnlocked 
                            ? isSelected 
                                ? 'border-blue-500 shadow-lg cursor-pointer' 
                                : 'border-slate-200 hover:border-blue-300 hover:shadow-md cursor-pointer'
                            : 'border-slate-300 cursor-not-allowed'
                    }`;

                    card.innerHTML = `
                        <div class="aspect-square p-4 flex items-center justify-center bg-slate-50 relative">
                            <img src="${image.path}" alt="${image.name}" class="w-full h-full object-contain ${
                                isUnlocked ? '' : 'ecg-image-silhouette'
                            }">
                            ${!isUnlocked ? `
                                <div class="absolute top-2 right-2 bg-slate-700/80 rounded-full p-1.5">
                                    <i class="fa-solid fa-lock text-white text-xs"></i>
                                </div>
                            ` : ''}
                        </div>
                        <div class="p-3 border-t border-slate-100">
                            <p class="text-sm font-bold ${isUnlocked ? 'text-slate-800' : 'text-slate-500'}">${image.name}</p>
                            ${isUnlocked 
                                ? isSelected 
                                    ? '<p class="text-xs text-blue-600 mt-1"><i class="fa-solid fa-check-circle mr-1"></i>é¸æŠä¸­</p>'
                                    : '<p class="text-xs text-green-600 mt-1"><i class="fa-solid fa-unlock mr-1"></i>è§£æ”¾æ¸ˆã¿</p>'
                                : requiredText 
                                    ? `<p class="text-xs text-slate-500 mt-1 font-medium">${requiredText}ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã§è§£æ”¾</p>`
                                    : ''
                            }
                        </div>
                    `;

                    if (isUnlocked) {
                        card.addEventListener('click', () => {
                            localStorage.setItem('ecg_selected_image', image.id);
                            applyImage(image.id);
                            renderCustomizeGrid();
                        });
                    }

                    customizeGrid.appendChild(card);
                });
            }

            // åˆæœŸåŒ–æ™‚ã«ç”»åƒã‚’é©ç”¨
            applyImage(getSelectedImage());

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            customizeButton.addEventListener('click', openCustomizeModal);
            customizeClose.addEventListener('click', closeCustomizeModal);
            customizeModal.querySelector('.ecg-customize-overlay').addEventListener('click', closeCustomizeModal);
        }
    </script>
    <script src="auth.js"></script>
</body>
</html>
